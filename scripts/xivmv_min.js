var xivmv=function(){function t(t){e=t}function i(e){var t,n,i,s,o=[];if(t%4>0){throw"Invalid string. Length must be a multiple of 4"}s=/=$/.test(e);n=s?e.length-4:e.length;for(t=0;t<n;t+=4){i=r.indexOf(e[t])<<18|r.indexOf(e[t+1])<<12|r.indexOf(e[t+2])<<6|r.indexOf(e[t+3]);o.push((i&16711680)>>16);o.push((i&65280)>>8);o.push(i&255)}if(s){e=e.substring(t,e.indexOf("="));if(e.length===2){i=r.indexOf(e[0])<<2|r.indexOf(e[1])>>4;o.push(i&255)}else{i=r.indexOf(e[0])<<10|r.indexOf(e[1])<<4|r.indexOf(e[2])>>2;o.push(i>>8&255);o.push(i&255)}}return o}function s(e,t){var n=null;try{var r=new Uint8Array(i(e));var s=new Zlib.Inflate(r);n=s.decompress()}catch(o){}return n}function u(e){var t=(e&32768)>>15;var n=(e&31744)>>10;var r=e&1023;if(n==0){return(t?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10))}else if(n==31){return r?NaN:(t?-1:1)*Infinity}return(t?-1:1)*Math.pow(2,n-15)*(1+r/Math.pow(2,10))}function a(e){var t={json:o.get(e),buffer_id:null,init_buffer:function(e){var t=this.json;this.buffer_id=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.buffer_id);switch(t.type){case"DXT1":e.compressedTexImage2D(e.TEXTURE_2D,0,e.extensions.compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,t.width,t.height,0,t.decoded.buffer);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);break;case"DXT5":e.compressedTexImage2D(e.TEXTURE_2D,0,e.extensions.compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,t.width,t.height,0,t.decoded.buffer);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);break;case"RGB8A8":e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,e.UNSIGNED_BYTE,t.decoded.buffer);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);break;case"RGBAF":e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,e.FLOAT,new Float32Array(t.decoded.buffer.buffer));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);break;default:throw"Unsupported texture format: "+t.type}e.bindTexture(e.TEXTURE_2D,null);return true},bind:function(e,t,n){var r=this.json;if($.isEmptyObject(r)){return false}if(e===null){throw"init_buffer called with empty gl"}if(this.buffer_id===null){if(!this.init_buffer(e)){return false}}e.activeTexture(e["TEXTURE"+n]);e.bindTexture(e.TEXTURE_2D,this.buffer_id);e.uniform1i(t,n);return true}};return{d:t,bind:t.bind.bind(t)}}function f(e){var t={json:o.get(e),textures:{diffuse:null,specular:null,normal:null,table:null,mask:null},get_texture:function(e){var t=this.json;if($.isEmptyObject(t)){return null}if(!e in this.textures){throw"get_texture called with invalid tex_name: "+e}if(this.textures[e]===null){if(e in t.components){this.textures[e]=a(t.components[e])}}return this.textures[e]}};return{d:t,get_texture:t.get_texture.bind(t)}}function l(e){var t={json:o.get(e),vertex_buffer_id:null,index_buffer_id:null,model_matrix:mat4.create(),new_material_version:1,material_version:null,materials:null,set_model_matrix:function(e){this.model_matrix=mat4.clone(e)},set_material_version:function(e){this.new_material_version=e},init_materials:function(){var e=this.json;this.materials=[];for(var t=0;t<e.meshes.length;t++){var n=e.meshes[t];var r=e.materials[n.material];if(this.new_material_version in r){this.materials.push(f(r[this.new_material_version]))}else{if(!$.isEmptyObject(r)){var i;for(i in r)break;this.materials.push(f(r[i]))}else{this.materials.push(null)}}}this.new_material_version=null},init_buffers:function(e){var t=this.json;this.vertex_buffer_id=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.vertex_buffer_id);e.bufferData(e.ARRAY_BUFFER,t.decoded.vertex_buffer,e.STATIC_DRAW);e.bindBuffer(e.ARRAY_BUFFER,null);this.index_buffer_id=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer_id);e.bufferData(e.ELEMENT_ARRAY_BUFFER,t.decoded.index_buffer,e.STATIC_DRAW);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)},bind_vertex_attrib:function(e,t,n,r,i,s){if(i.hasOwnProperty(s)){var o=i[s];var u=null;switch(o.type){case"float":u=e.FLOAT;break;case"ubyte":u=e.UNSIGNED_BYTE;break}e.vertexAttribPointer(t,o.size,u,false,r.stride,n.vertex_index*r.stride+o.offset)}},render:function(e,t,n){var r=this.json;if($.isEmptyObject(r)){return false}if(e===null){throw"render called with empty gl"}if(this.vertex_buffer_id===null){this.init_buffers(e)}if(this.new_material_version!==null){this.init_materials()}e.uniformMatrix4fv(t.uMMatrix,false,this.model_matrix);var i=mat4.create();mat4.mul(i,n,this.model_matrix);mat4.invert(i,i);e.uniformMatrix4fv(t.uInvMVMatrix,false,i);var s=r.elements;for(var o=0;o<r.meshes.length;o++){var u=r.meshes[o];e.bindBuffer(e.ARRAY_BUFFER,this.vertex_buffer_id);this.bind_vertex_attrib(e,t.attrs.aVertexPosition,u,r,s,"position");this.bind_vertex_attrib(e,t.attrs.aTextureCoord,u,r,s,"tex_coord");this.bind_vertex_attrib(e,t.attrs.aVertexNormal,u,r,s,"normal");this.bind_vertex_attrib(e,t.attrs.aVertexBinormal,u,r,s,"binormal");this.bind_vertex_attrib(e,t.attrs.aVertexColor,u,r,s,"color");e.bindBuffer(e.ARRAY_BUFFER,null);var a=this.materials[o];if(a===null){e.uniform1i(t.uDiffuse,false);e.uniform1i(t.uSpecular,false);e.uniform1i(t.uNormal,false);e.uniform1i(t.uTable,false)}else{var f=a.get_texture("diffuse");if(f&&f.bind(e,t.uDiffuseTex,0)){e.uniform1i(t.uDiffuse,true)}else{e.uniform1i(t.uDiffuse,false)}var l=a.get_texture("specular");if(l&&l.bind(e,t.uSpecularTex,1)){e.uniform1i(t.uSpecular,true)}else{e.uniform1i(t.uSpecular,false)}var c=a.get_texture("normal");if(c&&c.bind(e,t.uNormalTex,2)){e.uniform1i(t.uNormal,true)}else{e.uniform1i(t.uNormal,false)}var h=a.get_texture("table");if(h&&h.bind(e,t.uTableTex,3)){e.uniform1i(t.uTable,true)}else{e.uniform1i(t.uTable,false)}var p=a.get_texture("mask");if(p&&p.bind(e,t.uMaskTex,4)){e.uniform1i(t.uMask,true)}else{e.uniform1i(t.uMask,false)}}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer_id);e.drawElements(e.TRIANGLES,u.index_count,e.UNSIGNED_SHORT,u.index_index*2);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}}};return{d:t,render:t.render.bind(t),set_model_matrix:t.set_model_matrix.bind(t),set_material_version:t.set_material_version.bind(t)}}function c(e,t,n){var r=$.ajax({url:n,async:false}).responseText;var i=e.createShader(t);e.shaderSource(i,r);e.compileShader(i);if(!e.getShaderParameter(i,e.COMPILE_STATUS)){return null}return i}function h(e,t,n,r,i){var s=e.createProgram();e.attachShader(s,c(e,e.VERTEX_SHADER,"shaders/"+t+".glsl"));e.attachShader(s,c(e,e.FRAGMENT_SHADER,"shaders/"+n+".glsl"));e.linkProgram(s);if(!e.getProgramParameter(s,e.LINK_STATUS)){return null}s.attrs={};for(var o=0;o<r.length;o++){s.attrs[r[o]]=e.getAttribLocation(s,r[o])}for(var o=0;o<i.length;o++){s[i[o]]=e.getUniformLocation(s,i[o])}return s}function p(e,t){var n=["","WEBKIT_","MOZ_","IE_","O_"];for(var r=0;r<n.length;r++){var i=e.getExtension(n[r]+t);if(i){return i}}return null}function d(e,t){var n={};n.buffer=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n.buffer);n.texture=e.createTexture();e.bindTexture(e.TEXTURE_2D,n.texture);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,t,0,e.RGBA,e.UNSIGNED_BYTE,null);var r=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,r);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,t);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n.texture,0);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.bindTexture(e.TEXTURE_2D,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,null);return n}function v(e,t){var r={canvas:e,gl:null,options:$.extend({alpha_test:true,colors:true,antialias:true},t),models:[],fp_prg:null,lp_prg:null,pp_prgs:{},pp_steps:[],projection_matrix:mat4.perspective(mat4.create(),45,e.width/e.height,.1,100),view_matrix:mat4.translate(mat4.create(),mat4.create(),[0,-3,-10]),stopped:true,framebuffers:[],fb_size:2048,pp_scan_buffer:null,draw:function(){if(!this.stopped){n(this.draw.bind(this));var e=this.gl;e.useProgram(this.fp_prg);e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[1].buffer);e.viewport(0,0,this.fb_size,this.fb_size);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var t in this.fp_prg.attrs){e.enableVertexAttribArray(this.fp_prg.attrs[t])}e.uniformMatrix4fv(this.fp_prg.uPMatrix,false,this.projection_matrix);e.uniformMatrix4fv(this.fp_prg.uVMatrix,false,this.view_matrix);for(var r=0;r<this.models.length;r++){this.models[r].render(this.gl,this.fp_prg,this.view_matrix)}for(var t in this.fp_prg.attrs){e.disableVertexAttribArray(this.fp_prg.attrs[t])}var i;for(i=0;i<this.pp_steps.length;i++){e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[i%2].buffer);var s=this.pp_prgs[this.pp_steps[i]];e.useProgram(s);for(var t in s.attrs){e.enableVertexAttribArray(s.attrs[t])}e.uniform1f(s.uSize,this.fb_size);e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this.framebuffers[(i+1)%2].texture);e.uniform1i(s.uInTex,0);e.bindBuffer(e.ARRAY_BUFFER,this.pp_scan_buffer);e.vertexAttribPointer(s.attrs.aPosition,2,e.FLOAT,false,0,0);e.drawArrays(e.TRIANGLES,0,6);e.bindTexture(e.TEXTURE_2D,this.framebuffers[i%2].texture);for(var t in s.attrs){e.disableVertexAttribArray(s.attrs[t])}}e.bindFramebuffer(e.FRAMEBUFFER,null);e.viewport(0,0,this.canvas.width,this.canvas.height);e.useProgram(this.lp_prg);for(var t in this.lp_prg.attrs){e.enableVertexAttribArray(this.lp_prg.attrs[t])}e.uniform1f(this.lp_prg.uSize,this.fb_size);e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this.framebuffers[(i+1)%2].texture);e.uniform1i(this.lp_prg.uInTex,0);e.bindBuffer(e.ARRAY_BUFFER,this.pp_scan_buffer);e.vertexAttribPointer(this.lp_prg.attrs.aPosition,2,e.FLOAT,false,0,0);e.drawArrays(e.TRIANGLES,0,6);for(var t in this.lp_prg.attrs){e.disableVertexAttribArray(this.lp_prg.attrs[t])}}},update_options:function(e){$.extend(this.options,e);return this},start:function(){if(this.stopped){this.stopped=false;this.draw()}return this},stop:function(){this.stopped=true;return this},set_projection_matrix:function(e){this.projection_matrix=mat4.clone(e);return this},set_view_matrix:function(e){this.view_matrix=mat4.clone(e);return this},attach:function(e){var t=l(e);this.models.push(t);return t},detach:function(e){var t=this.models.indexOf(e);if(t!=-1){this.models.splice(t,1)}}};var i={antialias:false};r.gl=e.getContext("experimental-webgl",i)||e.getContext("webgl",i);if(!r.gl){return null}var s=r.gl;s.clearColor(0,0,0,0);s.enable(s.DEPTH_TEST);s.enable(s.CULL_FACE);s.cullFace(s.BACK);s.extensions={compressedTextureS3tc:p(s,"WEBGL_compressed_texture_s3tc"),textureFloat:p(s,"OES_texture_float")};if(!s.extensions.compressedTextureS3tc){alert("gl extension WEBGL_compressed_texture_s3tc has not been found!")}r.fp_prg=h(s,"fp_vs","fp_fs",["aVertexPosition","aTextureCoord","aVertexNormal","aVertexBinormal","aVertexColor"],["uPMatrix","uVMatrix","uMMatrix","uInvMVMatrix","uDiffuse","uSpecular","uNormal","uTable","uMask","uDiffuseTex","uSpecularTex","uNormalTex","uTableTex","uMaskTex"]);r.framebuffers.push(d(s,r.fb_size));r.framebuffers.push(d(s,r.fb_size));r.pp_scan_buffer=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,r.pp_scan_buffer);s.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s.STATIC_DRAW);r.pp_prgs.fxaa=h(s,"pp_vs","fxaa_fs",["aPosition"],["uSize","uInTex"]);r.pp_prgs.glow=h(s,"pp_vs","glow_fs",["aPosition"],["uSize","uInTex"]);r.lp_prg=h(s,"pp_vs","lp_fs",["aPosition"],["uSize","uInTex"]);return{d:r,update_options:r.update_options.bind(r),start:r.start.bind(r),stop:r.stop.bind(r),set_projection_matrix:r.set_projection_matrix.bind(r),set_view_matrix:r.set_view_matrix.bind(r),attach:r.attach.bind(r),detach:r.detach.bind(r)}}var e=null;var n=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var o={hash_table:{},get:function(e){if(e in this.hash_table){return this.hash_table[e]}else{this.hash_table[e]={};var t=this.hash_table[e];var n=null;switch(e.slice(-4)){case".tex":n="texture";break;case".mdl":n="model";break;case"mtrl":n="material";break;default:break}$.ajax({url:e+".json",dataType:"json",xhr:function(){xhrObj=$.ajaxSettings.xhr();xhrObj.addEventListener("progress",function(t){if(progressCallback){progressCallback(t,n,e)}},false);return xhrObj},success:function(e){$.extend(t,e);switch(n){case"texture":t.decoded={buffer:s(e.data,e.width*e.height)};break;case"model":t.decoded={vertex_buffer:s(e.vertex_buffer),index_buffer:s(e.index_buffer)};break;default:break}}});return t}}};return{create_model_viewer:v,set_progress_callback:t}}();