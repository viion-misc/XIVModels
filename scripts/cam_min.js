function progressCallback(e,t,n){$(".welcome_window").fadeOut();clearTimeout(stopLoading);var r=e.position||e.loaded,i=e.totalSize||e.total;var s="0%";if(r>i)s="100%";else s=Math.floor(r/i*100)+"%";r=Math.round(r/10)/100;i=Math.round(i/10)/100;var o="Kb";if(i>2e3){r=Math.round(r/10)/100;i=Math.round(i/10)/100;var o="Mb"}if(r>0&&i>0){var u=n.split("/");var a=u[u.length-1].split(".")[0];if($.inArray(a,loading)==-1){loading.push(a);ContentStatus.addLoading(t,a,r)}$("."+a+"-done").html(r);$("."+a+"-total").html(i+o);$("."+a+"-progress").stop(true,true).animate({width:s},500);if(e.loaded>=e.total){var f=loading.indexOf(a);loading.splice(f,1);ContentStatus.nullClass(a);setTimeout(function(){ContentStatus.removeLoading(a)},1e3)}}if(loading.length==0&&$(".loading").is(":visible")){stopLoading=setTimeout(function(){ContentStatus.hideLoading()},1e3)}}function doWork(){var e=document.getElementById("webgl_canvas");e.width=window.innerWidth;e.height=window.innerHeight;xivmv.set_progress_callback(progressCallback);model_viewer=xivmv.create_model_viewer(e).start();if(UrlModel.Hash){var t=JSON.parse(window.atob(UrlModel.Hash));Menu.loadEntities(t);for(var n in t){if(t.hasOwnProperty(n)&&t[n]){var r=t[n];Menu.set(r["menu"]);$("."+r["type"]+"-select option").filter(function(){return $(this).html().toLowerCase()==r["name"].toLowerCase()}).prop("selected",true)}}}else{$(".welcome_window").center();$(".welcome_window").fadeIn()}camera.init(e,model_viewer)}var camera={modelViewer:null,viewMat:mat4.create(),projectionMat:mat4.create(),xRot:0,yRot:0,zRot:0,altKey:false,ctrlKey:false,shiftKey:false,toggledRotation:false,xTrans:0,yTrans:-3,zTrans:-10,drag:false,dragButton:false,dragSpeed:[250,150],dragX:0,dragY:0,maxZoom:[-.75,-80],zoomSpeed:.5,autorotate:{active:false,steps:.01,fps:60,toggle:function(){if(camera.autorotate.active){camera.autorotate.active=false}else{camera.autorotate.active=true;camera.autorotate.start()}},start:function(){setTimeout(function(){camera.yRot=camera.yRot+=camera.autorotate.steps;camera.updateViewMat();if(camera.autorotate.active){camera.autorotate.start()}},1e3/camera.autorotate.fps)}},texture:{active:true,toggle:function(){if(camera.texture.active){camera.texture.active=false}else{camera.texture.active=true}model_viewer.update_options({texture:camera.texture.active})}},updateProjectionMat:function(e){mat4.perspective(this.projectionMat,45,e.width/e.height,.1,100);if(this.modelViewer){this.modelViewer.set_projection_matrix(this.projectionMat)}},updateViewMat:function(){var e=this.viewMat;mat4.identity(e);mat4.translate(e,e,[this.xTrans,this.yTrans,this.zTrans]);mat4.rotateX(e,e,this.xRot);mat4.rotateY(e,e,this.yRot);mat4.rotateZ(e,e,this.zRot);if(this.modelViewer){this.modelViewer.set_view_matrix(e)}},init:function(e,t){this.modelViewer=t;this.updateProjectionMat(e);this.updateViewMat();var n=this;window.onkeydown=function(t){if(t.keyCode==18){n.altKey=true}else if(t.keyCode==17){n.ctrlKey=true}else if(t.keyCode==16){n.shiftKey=true}if(t.keyCode==87||t.keyCode==38){e.modelMoveAndRotate(t,"move","UP")}if(t.keyCode==83||t.keyCode==40){e.modelMoveAndRotate(t,"move","DOWN")}if(t.keyCode==68||t.keyCode==39){e.modelMoveAndRotate(t,"move","RIGHT")}if(t.keyCode==65||t.keyCode==37){e.modelMoveAndRotate(t,"move","LEFT")}if(t.keyCode==73||t.keyCode==104||t.keyCode==90){e.modelMoveAndRotate(t,"rotate","UP")}if(t.keyCode==75||t.keyCode==98||t.keyCode==88){e.modelMoveAndRotate(t,"rotate","DOWN")}if(t.keyCode==76||t.keyCode==102||t.keyCode==81){e.modelMoveAndRotate(t,"rotate","RIGHT")}if(t.keyCode==74||t.keyCode==100||t.keyCode==69){e.modelMoveAndRotate(t,"rotate","LEFT")}if(t.keyCode==99||t.keyCode==107){e.modelMoveAndRotate(t,"zoom","IN")}if(t.keyCode==105||t.keyCode==109){e.modelMoveAndRotate(t,"zoom","OUT")}if(t.keyCode==36){e.modelMoveAndRotate("reset")}};window.onkeyup=function(e){n.altKey=false;n.ctrlKey=false;n.shiftKey=false};e.modelMoveAndRotate=function(e,t,r){var i=$("select").is(":focus");if(!i){e.preventDefault();if(t=="move"){var s=n.xTrans;var o=n.yTrans;switch(r){case"UP":o=o+.1;break;case"DOWN":o=o-.1;break;case"LEFT":s=s-.1;break;case"RIGHT":s=s+.1;break}n.yTrans=o;n.xTrans=s}else if(t=="rotate"){var s=n.xRot;var o=n.yRot;switch(r){case"RIGHT":o=o+.1;break;case"LEFT":o=o-.1;break;case"UP":s=s-.1;break;case"DOWN":s=s+.1;break}n.yRot=o;n.xRot=s}else if(t=="zoom"){var u=n.zTrans;switch(r){case"IN":n.zTrans+=n.zoomSpeed;break;case"OUT":n.zTrans-=n.zoomSpeed;break}if(n.zTrans<n.maxZoom[1]||n.zTrans>n.maxZoom[0]){n.zTrans=u}}else if(t=="reset"){n.xRot=0;n.yRot=0;n.zRot=0;n.xTrans=0;n.yTrans=-3;n.zTrans=-10}}n.updateViewMat();return false};e.addEventListener("blur",function(e){n.altKey=false;n.ctrlKey=false;n.shiftKey=false},false);e.addEventListener("mousewheel",function(e){var t=n.zTrans;if(e.wheelDelta>0){n.zTrans+=n.zoomSpeed}else{n.zTrans-=n.zoomSpeed}if(n.zTrans<n.maxZoom[1]||n.zTrans>n.maxZoom[0]){n.zTrans=t}else{n.updateViewMat()}},false);e.addEventListener("mousedown",function(e){$("select").blur();e.preventDefault();n.dragX=e.clientX;n.dragY=e.clientY;n.drag=true;n.dragButton=e.button;$("section, footer, .alux, .xivdb-info").addClass("zindex2")},false);e.addEventListener("mouseup",function(e){e.preventDefault();n.drag=false;$(".zindex2").removeClass("zindex2")},false);e.addEventListener("mouseout",function(e){e.preventDefault();document.body.style.cursor="default";n.drag=false},false);e.addEventListener("mousemove",function(e){if(n.drag){document.body.style.cursor="move";e.preventDefault();var t=e.clientX;var r=e.clientY;var i=(t-n.dragX)/n.dragSpeed[n.dragButton];var s=(r-n.dragY)/n.dragSpeed[n.dragButton];if(n.dragButton==0&&!n.ctrlKey&&!n.shiftKey){if(n.toggledRotation){n.zRot-=i;n.xRot+=s}else{n.yRot+=i;n.xRot+=s}}if((n.dragButton==1||n.dragButton==0&&n.ctrlKey)&&!n.shiftKey){n.yTrans-=s;n.xTrans+=i}if(n.dragButton==0&&n.shiftKey){var o=n.zTrans;s=s*2;n.zTrans-=s;if(n.zTrans<n.maxZoom[1]||n.zTrans>n.maxZoom[0]){n.zTrans=o}else{n.updateViewMat()}}n.dragX=e.clientX;n.dragY=e.clientY;n.updateViewMat()}else{document.body.style.cursor="default"}},false)}};var model_viewer;var model={};var loading=[];var stopLoading;